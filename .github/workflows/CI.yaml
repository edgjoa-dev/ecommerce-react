name: build and test feature branch

on:
  pull_request:
    branches: [develop]
    types: [opened, reopened, synchronize]


jobs:
  build-feature:
    runs-on: ubuntu-latest
    steps:
      #############################################################
      # 1- Checkout code from feature branch and setup Node.js
      ########################################################
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run tests (Vitest)
        run: yarn test

      - name: Build React Vite application
        run: yarn build

  #######################################################
  # Automatic merge to develop branch
  #######################################################
  merge-feature-into-develop:
    runs-on: ubuntu-latest
    needs: build-feature
    if: ${{ success() }}
    permissions:
      contents: write
      pull-requests: write
    steps:
      ########################################################
      # 1- Checkout source code from develop branch
      ########################################################
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          fetch-depth: 0

      ########################################################
      # 2- Merge into development branch
      ########################################################
      - name: Merge into development branch
        run: |
          git config --global user.email "workflow-bot@example.com"
          git config --global user.name "workflow-bot"
          git merge --no-ff --verbose origin/${{ github.event.pull_request.head.ref }} -m "Merge pull request #${{ github.event.number }}"

      ########################################################
      # 3- Push changes after merge
      ########################################################
      - name: Push changes after merge
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.base_ref }}

      ########################################################
      # 4- Send Slack notification
      ########################################################
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "ðŸš€ Nuevo Pull Request mergeado en *${{ github.base_ref }}*\nAutor: ${{ github.actor }}\nðŸ”— <${{ github.event.pull_request.html_url }}|Ver Pull Request>"
            }
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}

      ########################################################
      # 5- Call publish artifact workflow
      ########################################################
      - name: Trigger publish artifact workflow
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          event-type: publish-artifact-event
          client-payload: '{"base_branch": "${{ github.base_ref }}"}'
